import os
import sqlite3
import shutil

def convert_to_sqlite(source_folder, target_folder):
    # Recreate the target folder structure
    if not os.path.exists(target_folder):
        os.makedirs(target_folder)

    for root, dirs, files in os.walk(source_folder):
        for file in files:
            source_file_path = os.path.join(root, file)
            relative_path = os.path.relpath(source_file_path, source_folder)
            target_file_path = os.path.join(target_folder, relative_path)

            # Create directories if they don't exist
            os.makedirs(os.path.dirname(target_file_path), exist_ok=True)

            # If file is not sqlite, convert and store
            if not file.endswith('.sqlite'):
                # Convert file to sqlite
                with open(source_file_path, 'r', encoding='utf-8') as f:  # Specify encoding here
                    data = f.read()

                # Store data in SQLite database
                conn = sqlite3.connect(target_file_path + '.sqlite')
                c = conn.cursor()
                c.execute('''CREATE TABLE IF NOT EXISTS data (content TEXT)''')
                c.execute('''INSERT INTO data VALUES (?)''', (data,))
                conn.commit()
                conn.close()

            else:
                # Just copy SQLite files to target folder
                shutil.copy2(source_file_path, target_file_path)


def create_database(db_path):
    conn = sqlite3.connect(db_path)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS files (
                    id INTEGER PRIMARY KEY,
                    path TEXT,
                    is_directory INTEGER,
                    content BLOB
                 )''')
    conn.commit()
    conn.close()


def insert_files_into_database(folder_path, parent_id, db_path):
    conn = sqlite3.connect(db_path)
    c = conn.cursor()

    for item in os.listdir(folder_path):
        item_path = os.path.join(folder_path, item)
        is_directory = int(os.path.isdir(item_path))

        with open(item_path, 'rb') as f:
            content = f.read()

        c.execute('''INSERT INTO files (path, is_directory, content) VALUES (?, ?, ?)''', (item_path, is_directory, content))
        file_id = c.lastrowid

        if is_directory:
            insert_files_into_database(item_path, file_id, db_path)

    conn.commit()
    conn.close()


def recreate_folders_and_files(db_path, target_folder):
    conn = sqlite3.connect(db_path)
    c = conn.cursor()

    c.execute('''SELECT id, path, is_directory, content FROM files''')
    files = c.fetchall()

    for file in files:
        file_id, file_path, is_directory, content = file

        # Reconstruct the absolute file path in the target folder
        relative_path = os.path.relpath(file_path, '/path/to/source_folder')  # Replace '/path/to/source_folder' with your actual source folder path
        target_file_path = os.path.join(target_folder, relative_path)

        if is_directory:
            # Create directory if it doesn't exist
            os.makedirs(target_file_path, exist_ok=True)
        else:
            # Create directory for the file if it doesn't exist
            os.makedirs(os.path.dirname(target_file_path), exist_ok=True)
            # Write the file content
            with open(target_file_path, 'wb') as f:
                f.write(content)

    conn.close()


if __name__ == "__main__":
    source_folder = '/path/to/source_folder'
    target_folder = '/path/to/target_folder'
    db_path = '/path/to/database.db'

    # Convert files to SQLite and store in target_folder
    convert_to_sqlite(source_folder, target_folder)

    # Create database and insert files into it
    create_database(db_path)
    insert_files_into_database(source_folder, None, db_path)

    # Recreate folders and files from database
    recreate_folders_and_files(db_path, target_folder)
