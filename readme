import os
import sqlite3

def create_database(db_path):
    conn = sqlite3.connect(db_path)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS files (
                    id INTEGER PRIMARY KEY,
                    path TEXT,
                    is_directory INTEGER,
                    content BLOB
                 )''')
    conn.commit()
    conn.close()

def insert_files_into_database(folder_path, parent_id, db_path):
    conn = sqlite3.connect(db_path)
    c = conn.cursor()

    for item in os.listdir(folder_path):
        item_path = os.path.join(folder_path, item)
        is_directory = int(os.path.isdir(item_path))

        if is_directory:
            # Insert directory into database
            c.execute('''INSERT INTO files (path, is_directory) VALUES (?, ?)''', (item_path, 1))
            directory_id = c.lastrowid
            # Recursively insert files in the directory
            insert_files_into_database(item_path, directory_id, db_path)
        else:
            # Insert file into database
            with open(item_path, 'rb') as f:
                content = f.read()
            c.execute('''INSERT INTO files (path, is_directory, content) VALUES (?, ?, ?)''', (item_path, 0, content))

    conn.commit()
    conn.close()

def recreate_folders_and_files(db_path, target_folder):
    conn = sqlite3.connect(db_path)
    c = conn.cursor()

    c.execute('''SELECT id, path, is_directory, content FROM files''')
    files = c.fetchall()

    for file in files:
        file_id, file_path, is_directory, content = file

        # Reconstruct the absolute file path in the target folder
        relative_path = os.path.relpath(file_path, '/path/to/source_folder')  # Replace '/path/to/source_folder' with your actual source folder path
        target_file_path = os.path.join(target_folder, relative_path)

        if is_directory:
            # Create directory if it doesn't exist
            os.makedirs(target_file_path, exist_ok=True)
        else:
            # Create directory for the file if it doesn't exist
            os.makedirs(os.path.dirname(target_file_path), exist_ok=True)
            # Write the file content
            with open(target_file_path, 'wb') as f:
                f.write(content)

    conn.close()

if __name__ == "__main__":
    source_folder = '/path/to/source_folder'
    db_path = '/path/to/database.db'
    target_folder = '/path/to/target_folder'

    # Create database and insert files into it
    create_database(db_path)
    insert_files_into_database(source_folder, None, db_path)

    # Recreate folders and files from database
    recreate_folders_and_files(db_path, target_folder)
